# runtime-env

> **The twelve-factor app stores config in _environment variables_** (often shortened to env vars or env). Env vars are easy to change between deploys without changing any code. - [The Twelve-Factor App](https://12factor.net/config)

## Table of Content

- [Installation](#installation)
- [Usage](#usage)
- [Setup](#setup)
- [Configuration](#configuration)
- [Environment Variable Load Order](#environment-variable-load-order)

## Installation

```sh
$ npm i -D @runtime-env/cli
$ npx runtime-env --help
```

```
Usage: runtime-env [options] [command]

Options:
  -V, --version          output the version number
  -h, --help             display help for command

Commands:
  gen-js [options]       generate a JavaScript file that includes environment variables within an object, making them accessible through the globalThis property.
  gen-ts                 generate a TypeScript file that provides the corresponding type definitions for the JavaScript file generated by the gen-js command
  interpolate [options]  perform template interpolation by substituting environment variables
  help [command]         display help for command
```

## Usage

In this document, we assume that you have set the following environment variables:

```sh
# user environment
$ export TAG_ID="G-ABCD12345"
```

```ini
# .env
FIREBASE_CONFIG={"apiKey":"AIzaSk2CngkeAyDJr2BhzSprQXp8PsZs3VFJFMA","authDomain":"example.firebaseapp.com"}
```

For JavaScript/TypeScript, you can read environment variables through the globalThis property:

```js
// Syntax: globalThis.<globalVariableName>.<environmentVariableName>
initializeApp(globalThis.runtimeEnv.FIREBASE_CONFIG);
// or
initializeApp(runtimeEnv.FIREBASE_CONFIG);
```

For HTML, you can read environment variables by a template:

```html
<!-- Syntax: <%= <globalVariableName>.<environmentVariableName> %> -->
<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=<%= runtimeEnv.TAG_ID %>"
></script>
```

We use <a href='https://lodash.com/docs/4.17.15#template' target='_blank'>lodash.template</a> to interpolate.

## Setup

1. Create a [configuration](#configuration) file:

   `.runtimeenvrc.json`

   ```json
   {
     "globalVariableName": "runtimeEnv",
     "envSchemaFilePath": ".runtimeenvschema.json",
     "genJs": [
       {
         "mode": "production",
         "envFilePath": null,
         "userEnvironment": true,
         "outputFilePath": "dist/runtime-env.js"
       }
     ],
     "genTs": {
       "outputFilePath": "src/runtime-env.d.ts"
     }
   }
   ```

1. Create a JSON schema file:

   `.runtimeenvschema.json`:

   ```json
   {
     "type": "object",
     "properties": {
       "TAG_ID": {
         "type": "string"
       },
       "FIREBASE_CONFIG": {
         "type": "object",
         "properties": {
           "apiKey": {
             "type": "string"
           },
           "authDomain": {
             "type": "string"
           }
         },
         "required": ["apiKey", "authDomain"]
       }
     },
     "required": ["TAG_ID", "FIREBASE_CONFIG"]
   }
   ```

   We use <a href='https://ajv.js.org/' target='_blank'>Ajv</a> to parse <a href='https://json-schema.org/' target='_blank'>JSON-schema</a>.

1. Configure your package.json, Dockerfile, etc. to generate, and interpolate files:

   For example, running `runtime-env gen-js`, then start your app:

   ```sh
   $ npx runtime-env gen-js --mode development && npm run start
   ```

   this will generate a JavaScript file similar to the following:

   ```js
   // runtime-env.js
   globalThis.runtimeEnv = {
     TAG_ID: "G-ABCD12345",
     FIREBASE_CONFIG: {
       apiKey: "AIzaSk2CngkeAyDJr2BhzSprQXp8PsZs3VFJFMA",
       authDomain: "example.firebaseapp.com",
     },
   };
   ```

   and, before using it, make sure to import the generated file:

   ```html
   <!-- index.html -->
   <script src="/runtime-env.js"></script>
   <script src="/main.js"></script>
   ```

   For another example, running `runtime-env interpolate`, then start nginx:

   ```sh
   npx runtime-env interpolate --input-file-path index.html --output-file-path index.html

   nginx -g "daemon off;"
   ```

   this will modify the 'index.html' to appear as follows:

   ```html
   <script
     async
     src="https://www.googletagmanager.com/gtag/js?id=G-ABCD12345"
   ></script>
   ```

   You can see more examples [here](./examples/).

1. Further setups:

   - You **NEED** to set up your web server to stop runtime-env.js to be cached by browser or CDNs.

   - To use runtime-env on systems that don't have Node.js installed, you'll need to pack `runtime-env` CLI into a single runnable file. Here's how you can do it:

     - Make a single runnable app using NodeJS's [Single Executable Applications](https://nodejs.org/api/single-executable-applications.html) feature (experimental).

     - Pack runtime-env into a runnable file using [pkg](https://github.com/vercel/pkg):

       ```sh
       $ pkg ./node_modules/@runtime-env/cli/bin/runtime-env.js --target node18-alpine-x64 --output runtime-env
       ```

   - If you're making a PWA (Progressive Web App), you **HAVE TO** set up your ServiceWorker to choose the right way to cache runtime-env.js.

## Configuration

### File

Runtime-env uses [cosmiconfig](https://www.npmjs.com/package/cosmiconfig) for configuration file support. Visit [here](https://www.npmjs.com/package/cosmiconfig#searchplaces) to see all available places to configure (replace `moduleName` with `runtimeenv`).

### Options

| Default    | Path                      | Type                                        | Description                                                                        |
| ---------- | ------------------------- | ------------------------------------------- | ---------------------------------------------------------------------------------- |
| _required_ | `globalVariableName`      | `string`                                    |                                                                                    |
| _required_ | `envSchemaFilePath`       | `string`                                    | File path related to `process.cwd()`                                               |
|            | `genJs`                   | `array`                                     |                                                                                    |
| _required_ | `genJs.*`                 | `object`                                    |                                                                                    |
| _required_ | `genJs.*.mode`            | `string`                                    | Instruct the CLI which configuration to use                                        |
| `null`     | `genJs.*.envFilePath`     | `null` \| `string` \| `[string, ...string]` | Leave `null` to mean no env files are loaded. File path related to `process.cwd()` |
| _required_ | `genJs.*.userEnvironment` | `boolean`                                   | Indicates whether environment variables should be loaded from `process.env`.       |
| _required_ | `genJs.*.outputFilePath`  | `string`                                    |                                                                                    |
|            | `genTs`                   | object                                      |                                                                                    |
| _required_ | `genTs.outputFilePath`    | string                                      | File path related to `process.cwd()`                                               |

## Environment Variable Load Order

Environment variables are looked up in the following places, in order, stopping once the variables is found.

1. `process.env`
1. `genJs.*.envFilePath[N-1]`
1. `genJs.*.envFilePath[N-2]`
1. `genJs.*.envFilePath[...]`
1. `genJs.*.envFilePath[0]`
