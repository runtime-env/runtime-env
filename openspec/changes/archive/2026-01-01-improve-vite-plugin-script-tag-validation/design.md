# Design: Improved Vite Plugin Script Tag Validation

## Context

The `@runtime-env/vite-plugin` relies on the user including a script tag for `/runtime-env.js` in their `index.html`. This file is served by the plugin's middleware in dev/preview and generated by the CLI in production.

## Goals

- Ensure `runtime-env.js` is correctly referenced in `index.html`.
- Fail early (at build time) if the reference is missing.
- Handle Vite's `base` configuration correctly.

## Decisions

### 1. Robust Detection Regex

A new utility function `hasRuntimeEnvScript(html: string, base: string): boolean` will be added to `packages/vite-plugin/src/utils.ts`.

The regex will follow this pattern:
`/<script\b[^>]*?\bsrc\s*=\s*(['"])([^'"]*\/runtime-env\.js)\1[^>]*?>\s*<\/script>/i`

Validation logic:

- Extract the `src` value.
- Normalize `base` (ensure it starts with `/` and doesn't end with `/` unless it's just `/`).
- The `src` should match exactly `${base}/runtime-env.js` (normalized).

### 2. Build Failure Mechanism

In `packages/vite-plugin/src/build.ts`, the `transformIndexHtml` hook will use `hasRuntimeEnvScript`.
If it returns `false`, it will:

1. Log a descriptive error message using Vite's logger.
2. Throw an error or call `process.exit(1)` to stop the build.

### 3. Dev Mode Resiliency

In `packages/vite-plugin/src/dev.ts`, the `transformIndexHtml` hook will also use `hasRuntimeEnvScript`.
If it returns `false`, it will continue to log a warning (not an error) to remain developer-friendly and resilient, as per current specs.

### 4. Preview Mode

Since `preview` mode runs on the output of `build`, and `build` now guarantees the presence of the script tag, no additional validation is needed in `preview.ts`.

## Risks / Trade-offs

- **Regex Complexity**: Extremely complex or unconventional script tag patterns might still evade detection. However, the proposed regex covers 99% of standard use cases.
- **Breaking Change**: Users who intentionally omitted the tag (e.g., using a custom loading strategy) will find their builds failing. We should clearly document that this tag is mandatory for the plugin to function correctly.
